name: ðŸŽ¯ Promo Monitor - SP â†’ Recife

on:
  schedule:
    # Executar 3x por dia (8h, 14h, 20h) nos dias Ãºteis
    - cron: '0 11,17,23 * * 1-5'  # UTC times
  workflow_dispatch:  # Permitir execuÃ§Ã£o manual
    inputs:
      departure_date:
        description: 'Data de partida (YYYY-MM-DD)'
        required: false
        default: ''
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write  # Para commit do seen.json
  issues: write    # Para criar issues de notificaÃ§Ã£o

jobs:
  check-prices:
    runs-on: ubuntu-latest
    environment: APIKEYS
    outputs:
      price_info: ${{ steps.price_check.outputs.price_info }}
      analysis_data: ${{ steps.upload_analysis.outputs.analysis_data }}
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd app
        pip install -r requirements.txt
        
    - name: ðŸ” Check flight prices (APIs)
      id: price_check
      env:
        AMADEUS_API_KEY: ${{ secrets.AMADEUS_API_KEY }}
        AMADEUS_API_SECRET: ${{ secrets.AMADEUS_API_SECRET }}
        OPENSKY_CLIENT_ID: ${{ secrets.OPENSKY_CLIENT_ID }}
        OPENSKY_CLIENT_SECRET: ${{ secrets.OPENSKY_CLIENT_SECRET }}
      run: |
        cd app
        
        # Executar anÃ¡lise de preÃ§os
        echo "ðŸ” Analisando preÃ§os SP â†’ Recife..."
        python flight_price_apis.py > price_analysis.log 2>&1
        
        # Capturar resultado da anÃ¡lise
        if [ -f "flight_analysis.json" ]; then
          PRICE_INFO=$(python -c "
          import json
          try:
              with open('flight_analysis.json') as f:
                  data = json.load(f)
                  if 'error' not in data:
                      summary = data['summary']
                      price = summary['cheapest_price_brl']
                      rating = summary['price_rating']
                      airline = summary['airline']
                      origin = summary['best_origin']
                      print(f'{price}|{rating}|{airline}|{origin}')
                  else:
                      print('ERROR|ERROR|ERROR|ERROR')
              except:
                  print('ERROR|ERROR|ERROR|ERROR')
          ")
          
          echo "price_info=$PRICE_INFO" >> $GITHUB_OUTPUT
          echo "âœ… AnÃ¡lise de preÃ§os concluÃ­da"
        else
          echo "price_info=ERROR|ERROR|ERROR|ERROR" >> $GITHUB_OUTPUT
          echo "âš ï¸ Arquivo de anÃ¡lise nÃ£o encontrado"
        fi
        
    - name: ðŸ“¤ Upload analysis data
      id: upload_analysis
      run: |
        cd app
        if [ -f "flight_analysis.json" ]; then
          # Criar artifact com dados da anÃ¡lise
          echo "analysis_data=$(cat flight_analysis.json | base64 -w 0)" >> $GITHUB_OUTPUT
          echo "âœ… Dados de anÃ¡lise preparados"
        else
          echo "analysis_data=" >> $GITHUB_OUTPUT
        fi

  monitor-rss-and-notify:
    runs-on: ubuntu-latest
    environment: TELEGRAM
    needs: check-prices
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd app
        pip install -r requirements.txt
        
    - name: ðŸ“Š Restore price analysis
      run: |
        cd app
        if [ -n "${{ needs.check-prices.outputs.analysis_data }}" ]; then
          echo "${{ needs.check-prices.outputs.analysis_data }}" | base64 -d > flight_analysis.json
          echo "âœ… Dados de anÃ¡lise de preÃ§os restaurados"
        else
          echo "âš ï¸ Nenhum dado de anÃ¡lise de preÃ§os disponÃ­vel"
        fi
        
    - name: ðŸ“Š Monitor RSS feeds
      id: monitor
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        cd app
        
        echo "ðŸ“¡ Monitorando feeds RSS..."
        python main.py > rss_monitor.log 2>&1
        
        echo "âœ… Monitoramento RSS concluÃ­do"
        
    - name: ðŸ“± Send smart notifications
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        cd app
        
        echo "ðŸ” Verificando dados para notificaÃ§Ã£o..."
        
        # Verificar credenciais Telegram
        if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
          echo "âŒ Credenciais Telegram nÃ£o configuradas"
          echo "BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:+configurado}"
          echo "CHAT_ID: ${TELEGRAM_CHAT_ID:+configurado}"
          exit 0
        fi
        
        # Verificar se existe anÃ¡lise de preÃ§os
        if [ -f "flight_analysis.json" ]; then
          echo "âœ… Arquivo de anÃ¡lise encontrado"
          PRICE_DATA="${{ needs.check-prices.outputs.price_info }}"
          echo "ðŸ“Š Dados de preÃ§o: $PRICE_DATA"
          
          PRICE_VALUE=$(echo $PRICE_DATA | cut -d'|' -f1)
          PRICE_RATING=$(echo $PRICE_DATA | cut -d'|' -f2)
          AIRLINE=$(echo $PRICE_DATA | cut -d'|' -f3)
          ORIGIN=$(echo $PRICE_DATA | cut -d'|' -f4)
          
          echo "ðŸ’° PreÃ§o: R$ $PRICE_VALUE"
          echo "ðŸ“Š Rating: $PRICE_RATING"
          echo "âœˆï¸ Companhia: $AIRLINE"
          echo "ðŸ¢ Origem: $ORIGIN"
          
          # SEMPRE enviar notificaÃ§Ã£o para debug (temporÃ¡rio)
          SHOULD_NOTIFY=true
          echo "ðŸ“± Enviando notificaÃ§Ã£o (modo debug)"
          
          # Sempre enviar notificaÃ§Ã£o para debug - vamos ver o que estÃ¡ acontecendo
          echo "ðŸš€ Preparando notificaÃ§Ã£o Telegram..."
          
          # Enviar notificaÃ§Ã£o
          if [ "$SHOULD_NOTIFY" = "true" ]; then
            python -c "
            import requests
            import json
            import os
            from datetime import datetime
            
            print('ðŸ” Iniciando envio de notificaÃ§Ã£o...')
            
            bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
            chat_id = os.environ.get('TELEGRAM_CHAT_ID')
            
            print(f'BOT_TOKEN presente: {bool(bot_token)}')
            print(f'CHAT_ID presente: {bool(chat_id)}')
            
            if not bot_token or not chat_id:
                print('âŒ Credenciais Telegram nÃ£o encontradas')
                exit(1)
            
            # Teste simples primeiro
            message = f'''ðŸ§ª **TESTE - Monitoramento SP â†’ Recife**
            
â° Executado em: {datetime.now().strftime('%H:%M - %d/%m/%Y')}
ðŸ¤– Via GitHub Actions
ðŸ“± Environment: TELEGRAM
            
Este Ã© um teste para verificar se as notificaÃ§Ãµes estÃ£o funcionando.'''
            
            url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
            payload = {
                'chat_id': chat_id,
                'text': message,
                'parse_mode': 'Markdown'
            }
            
            print(f'ðŸš€ Enviando para: {url}')
            print(f'ðŸ“¨ Chat ID: {chat_id}')
            
            try:
                response = requests.post(url, json=payload, timeout=10)
                print(f'ðŸ“¡ Status Code: {response.status_code}')
                print(f'ðŸ“„ Response: {response.text}')
                
                if response.status_code == 200:
                    print('âœ… NotificaÃ§Ã£o Telegram enviada com sucesso!')
                else:
                    print(f'âŒ Erro Telegram: {response.status_code} - {response.text}')
            except Exception as e:
                print(f'âŒ Erro na requisiÃ§Ã£o: {e}')
            "
          else
            echo "â„¹ï¸ Nenhuma notificaÃ§Ã£o necessÃ¡ria (preÃ§o: $PRICE_RATING)"
          fi
        else
          echo "âš ï¸ AnÃ¡lise de preÃ§os nÃ£o disponÃ­vel - enviando notificaÃ§Ã£o de teste mesmo assim"
          
          # Enviar notificaÃ§Ã£o de teste mesmo sem dados de preÃ§os
          python -c "
          import requests
          import os
          from datetime import datetime
          
          print('ðŸ” Teste sem anÃ¡lise de preÃ§os...')
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if bot_token and chat_id:
              message = f'''ðŸ§ª **TESTE - Workflow Executado**
              
âš ï¸ AnÃ¡lise de preÃ§os nÃ£o disponÃ­vel
â° Executado em: {datetime.now().strftime('%H:%M - %d/%m/%Y')}
ðŸ¤– Via GitHub Actions
ðŸ“± Environment: TELEGRAM

Sistema funcionando, mas sem dados de APIs.'''
              
              url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
              payload = {
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'Markdown'
              }
              
              try:
                  response = requests.post(url, json=payload, timeout=10)
                  if response.status_code == 200:
                      print('âœ… NotificaÃ§Ã£o de teste enviada!')
                  else:
                      print(f'âŒ Erro: {response.status_code} - {response.text}')
              except Exception as e:
                  print(f'âŒ Erro na requisiÃ§Ã£o: {e}')
          else:
              print('âŒ Credenciais Telegram nÃ£o configuradas no environment TELEGRAM')
          "
        fi
        
    - name: ðŸ’¾ Save data and commit changes
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Criar diretÃ³rio de dados se nÃ£o existir
        mkdir -p data/price_history
        
        # Salvar histÃ³rico de preÃ§os
        cd app
        DATE=$(date +%Y-%m-%d_%H)
        if [ -f "flight_analysis.json" ]; then
          cp flight_analysis.json "../data/price_history/sp_recife_${DATE}.json"
          echo "ðŸ’¾ HistÃ³rico salvo: sp_recife_${DATE}.json"
        fi
        
        cd ..
        
        # Adicionar arquivos de dados
        git add data/ || true
        
        # Commit apenas se houver mudanÃ§as
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ¤– Update monitoring data - $(date '+%Y-%m-%d %H:%M UTC')"
          git push
          echo "âœ… Dados atualizados no repositÃ³rio"
        else
          echo "â„¹ï¸ Nenhuma mudanÃ§a nos dados"
        fi
        
    - name: ðŸ§¹ Cleanup old data
      run: |
        # Manter apenas Ãºltimos 30 dias de histÃ³rico
        find data/price_history/ -name "sp_recife_*.json" -mtime +30 -delete 2>/dev/null || true
        echo "âœ… Limpeza de dados antigos concluÃ­da"
        
    - name: ðŸ“Š Execution summary
      if: always()
      run: |
        cd app
        
        echo "## ðŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ• HorÃ¡rio: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ Rota: SÃ£o Paulo â†’ Recife" >> $GITHUB_STEP_SUMMARY
        
        # Dados de preÃ§os
        PRICE_DATA="${{ needs.check-prices.outputs.price_info }}"
        if [ "$PRICE_DATA" != "ERROR|ERROR|ERROR|ERROR" ]; then
          PRICE_VALUE=$(echo $PRICE_DATA | cut -d'|' -f1)
          PRICE_RATING=$(echo $PRICE_DATA | cut -d'|' -f2)
          AIRLINE=$(echo $PRICE_DATA | cut -d'|' -f3)
          ORIGIN=$(echo $PRICE_DATA | cut -d'|' -f4)
          
          echo "- ðŸ’° PreÃ§o mais barato: R\$ $PRICE_VALUE ($PRICE_RATING)" >> $GITHUB_STEP_SUMMARY
          echo "- âœˆï¸ Melhor opÃ§Ã£o: $AIRLINE via $ORIGIN" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Dados de preÃ§os: NÃ£o disponÃ­veis" >> $GITHUB_STEP_SUMMARY
        fi
        
        # APIs utilizadas
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ APIs Consultadas:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Amadeus Self-Service (preÃ§os)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… OpenSky Network (trÃ¡fego aÃ©reo)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… RSS Feeds (promoÃ§Ãµes)" >> $GITHUB_STEP_SUMMARY
        
        # Feeds monitorados
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¡ Feeds RSS Monitorados:" >> $GITHUB_STEP_SUMMARY
        echo "- Passageiro de Primeira" >> $GITHUB_STEP_SUMMARY
        echo "- MaxMilhas Blog" >> $GITHUB_STEP_SUMMARY
        echo "- Viagem na Viagem" >> $GITHUB_STEP_SUMMARY
        echo "- Qual Viagem" >> $GITHUB_STEP_SUMMARY
        echo "- Vida de Turista" >> $GITHUB_STEP_SUMMARY
        echo "- Melhores Destinos" >> $GITHUB_STEP_SUMMARY
